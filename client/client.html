<!DOCTYPE html>
<html lang="en">
<head>
    <!-- import the websocket client library. You can code websockets from scratch
         but we will just import a library. In this case we are using socket.io which is 
         one of the most popular and feature rich websocket libraries.
         
         You can point the src for the script to any host online, but
         by default the socket.io nodejs library will host the client library
         online at your node.js address under /socket.io/socket.io.js 
         You can disable that on the server if desired
    -->
	<script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
	<script>
		// hack in exports so things don't break
		window.exports = window.exports || {};
	</script>
	<script src="/messages.js"></script>
	<script type="text/babel">

		let autoIncrmentId = 0;
		let user = '';
		const sentMessages = {};
		const messages = [];

		function getMessageLine(message) {
            const statusSymbols = [0, 'P','D','S','E'];
            const status = message.name === user ? '(' + statusSymbols[message.status] + ')' : '';
		    return `${message.name}: ${message.msg} ${status}\n`;
		}

		function getChatContent(messages) {
		    return messages.reduce((content, message) => {
		        return content + getMessageLine(message);
			}, '');
		}

		function updateChat(chat, messages) {
            chat.innerHTML = getChatContent(messages);
            chat.scrollTop = chat.scrollHeight;
        }

		const connectedSocket = (e) => {
			const message = document.querySelector('#message');
			const chat = document.querySelector('#chat');
            const send = document.querySelector('#send');
			const socket = io.connect();

			const roomName = document.querySelector('#roomName');
			const usersList = document.querySelector('#users');

			socket.on('connect', () => {
				console.log('connecting');

				const userField = document.querySelector('#username');
				user = userField.value;

				if(!user) {
					user = 'unknown';
				}

				socket.emit('join', {name: user});
				document.querySelector('#connect-container').style.display = 'none';
				send.disabled = false;
				message.disabled = false;
			});

            /**
			 * When the server sends the message history, replace the contents of the local message history
             */
			socket.on('history', (data) => {
			    if(!(data instanceof Array)) {
			        return;
				}

				messages.unshift.apply(messages, data.reverse());
                updateChat(chat, messages);
			});

			socket.on('msg', (data) => {
			    let msg = null;
			    // check if this is a message we sent and was received by the server
				if(sentMessages[data.clientId]){
				    // If so whatever data the server sends back is the "correct" version
				    msg = sentMessages[data.clientId];
				    Object.assign(msg, data);
				}
				else {
				    // If the message was from another user, create a new object for it
				    msg = new ClientMessage(data);
				}

				// Add the message to the local history
                messages.push(msg);

                updateChat(chat, messages);
				socket.emit('delivered', msg);
				console.log(data);
			});

			// If one of our messages was delivered
			socket.on('delivered', (data) => {
			    // check if it's still pending
                if(sentMessages[data.clientId]){
                    // mark the message as delivered
                    sentMessages[data.clientId].setStatus(MessageStatus.Delivered);
                    delete sentMessages[data.clientId];
                }

                console.log(messages);
                updateChat(chat, messages);
			});

			socket.on('status', (data) =>{
				roomName.innerHTML = data.roomName;

				usersList.innerHTML = '';
				data.users.forEach((user) => {
					const li = document.createElement('li');
					const inactiveElapsed = user.lastActive === 'now' ? '' : `<span class='inactive-elapsed'>${user.lastActive}</span>`;

					li.className = 'user';
					li.innerHTML = `${user.name} ${inactiveElapsed}`;

					if(user.lastActive === 'now') {
						li.className += ' active';
					}

					usersList.appendChild(li);
				});
			});

			const sendMessage = (e) => {
				const msg = message.value;

				if(msg) {
				    const newMessage = new ClientMessage({
				        name: user,
				        msg: msg,
						clientId: autoIncrmentId++});

				    // Temporarily append the message to the chat content
					// FIXME: if another user sends a message before this one is delivered, it will disappear
				    chat.innerHTML += getMessageLine(newMessage);
				    chat.scrollTop = chat.scrollHeight;

				    // Save a reference to the sent message
					sentMessages[newMessage.clientId] = newMessage;
					socket.emit('msg', newMessage);
					// Clear out message field
					message.value = '';
				}
			};

			send.addEventListener('click', sendMessage);
			message.addEventListener('keydown', function(e){
			    if(e.which == 13) {
			        sendMessage(e);
				}
			});
		};

		const init = () => {
			const connect = document.querySelector('#connect');
			connect.addEventListener('click', connectedSocket);
		};

		window.onload = init;

	</script>
	<style>
		html, body {
			font: 100% Arial, Sans;
		}

		#chat {
			width: 40em;
			height: 30em;
			overflow-y: scroll;
			border: 1px #ccc solid;
			padding: .3em;
			display: inline-block;
			vertical-align: top;
			margin: 0 0 .3em;
		}

		#message {
			width: 35em;
			padding: .3em;
		}

		#send {
			width: 4em;
			padding: .3em;
		}

		#status {
			display: inline-block;
			height: 20em;
			width: 15em;
			border: 1px #ccc solid;
			padding: .3em;
			vertical-align: top;
		}

		#roomName {
			font-size: 1.2em;
			margin: .3em;
		}

		#users {
			padding: .3em;
		}

		#users li.user {
			list-style: none;
		}

		li.user.active:after {
			content: '';
			background: #44ee44;
			box-sizing: border-box;
			display: inline-block;
			vertical-align: middle;
			height: .5em;
			width: .5em;
			border-radius: .5em;
		}

		.inactive-elapsed {
			font-size: .8em;
			color: #777;
			margin-left: .5em;
		}
	</style>
</head>
<body>
<div id="connect-container">
	<label for="username">Username:</label>
	<input id="username" name="user" type="text"/>
	<input id="connect" type='button' value='connect'/>
</div>
<pre id="chat"></pre>
<div id="status">
	<h3 id="roomName"></h3>
	<ul id="users"></ul>
</div>
<div>
	<input id="message" name="message" type="text" disabled placeholder="Type a message..."/>
	<input id="send" type="button" value="send" disabled />
</div>
</body>
</html>