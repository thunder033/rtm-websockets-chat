<!DOCTYPE html>
<html lang="en">
<head>
    <!-- import the websocket client library. You can code websockets from scratch
         but we will just import a library. In this case we are using socket.io which is 
         one of the most popular and feature rich websocket libraries.
         
         You can point the src for the script to any host online, but
         by default the socket.io nodejs library will host the client library
         online at your node.js address under /socket.io/socket.io.js 
         You can disable that on the server if desired
    -->
	<script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
	<script>
		// hack in exports so things don't break
		window.exports = window.exports || {};
	</script>
	<script src="/messages.js"></script>
	<script type="text/babel">

		let autoIncrmentId = 0;
		let user = '';
		const sentMessages = {};
		const messages = [];

		function getMessageLine(message) {
            const statusSymbols = [0, 'P','D','S','E'];
            const status = message.name === user ? '(' + statusSymbols[message.status] + ')' : '';
		    return `${message.name}: ${message.msg} ${status}\n`;
		}

		function getChatContent(messages) {
		    return messages.reduce((content, message) => {
		        return content + getMessageLine(message);
			}, '');
		}

		const connectedSocket = (e) => {
			const message = document.querySelector('#message');
			const chat = document.querySelector('#chat');
            const send = document.querySelector('#send');
			const socket = io.connect();

			socket.on('connect', () => {
				console.log('connecting');

				const userField = document.querySelector('#username');
				user = userField.value;

				if(!user) {
					user = 'unknown';
				}

				socket.emit('join', {name: user});
				document.querySelector('#connect-container').style.display = 'none';
				send.disabled = false;
			});

			socket.on('msg', (data) => {
			    let msg = null;
				if(sentMessages[data.clientId]){
				    msg = sentMessages[data.clientId];
				    Object.assign(msg, data);
				}
				else {
				    msg = new ClientMessage(data);
				}

                messages.push(msg);

                chat.innerHTML = getChatContent(messages);
				socket.emit('delivered', msg);
				console.log(data);
			});

			socket.on('delivered', (data) => {
                if(sentMessages[data.clientId]){
                    console.log(`set message ${data.id} to status ${MessageStatus.Delivered}`);
                    sentMessages[data.clientId].setStatus(MessageStatus.Delivered);
                    delete sentMessages[data.clientId];
                }

                console.log(messages);
                chat.innerHTML = getChatContent(messages);
			});

			const sendMessage = (e) => {
				const msg = message.value;

				console.log(`sending message: ${msg}`);
				if(msg) {
				    const newMessage = new ClientMessage({
				        name: user,
				        msg: message.value,
						clientId: autoIncrmentId++});

				    chat.innerHTML += getMessageLine(newMessage);
					sentMessages[newMessage.clientId] = newMessage;
					socket.emit('msg', newMessage);
				}
			};


			send.addEventListener('click', sendMessage);
		};

		const init = () => {
			const connect = document.querySelector('#connect');
			connect.addEventListener('click', connectedSocket);
		};

		window.onload = init;

	</script>
	<style>
		#chat {
			width: 40em;
			height: 30em;
		}
	</style>
</head>
<body>
<div id="connect-container">
	<label for="username">Username:</label>
	<input id="username" name="user" type="text"/>
	<input id="connect" type='button' value='connect'/>
</div>
<pre id="chat"></pre>
<div>
	<label for="message">Message:</label>
	<input id="message" name="message" type="text"/>
	<input id="send" type="button" value="send" disabled />
</div>
</body>
</html>